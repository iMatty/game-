<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SteamAPI test</title>
    <script src="./js/angular.min.js"></script>
    <script src="./js/angular-filter.min.js"></script>
</head>

<body>
    <div ng-app="steamApi" ng-controller="steamApiCtrl">
            <p>{{tester}}</p>
        Name:
        <input ng-model="search" ng-model-options="{debounce: 800}">
        <table>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Price</th>
            </tr>
            <tr ng-repeat="x in game | unique: 'app'">
                <td>{{x.name}}</td>
                <td>{{x.type}}</td>
                <td>{{x.price}}</td>
            </tr>
        </table>
    </div>

    <script>
        var appList = [];
        var filterList = [];
        var mapList = [];
        var gameList = [];

        var app = angular.module("steamApi", ["angular.filter"]);
        app.controller("steamApiCtrl", function($scope, $http, $filter) {
            $scope.search = "";
            getAppList();
            $scope.$watch("search", function() {
                filterAppList(); 
            });

            function getAppList() {
                $http.get("./data/steam-min.json")
                .then(function(response) {
                    appList = response.data.applist.apps;
                })
                .catch(function(error) {})
            };

            function filterAppList() {
                if($scope.search.length >= 3) {
                    filterList = $filter("filter")(appList, {name: $scope.search});
                    mapList = filterList.map(id => id.app);
                    gameList = [];
                    getGameList();
                } else {
                    filterList = [];
                    mapList = [];
                    gameList = [];
                    $scope.game = gameList;
                }      
            };

            function getGameList() {
                    $http.get("https://store.steampowered.com/api/appdetails?appids=" + mapList.join(",") + "&filters=price_overview")
                    .then(function(response) {
                        for(let i = 0; i < mapList.length; i++) {
                            if(response.data[mapList[i]].success) {
                                if(response.data[mapList[i]].data.price_overview != undefined) {
                                    gameList.push({
                                        name: filterList[i].name,
                                        app: filterList[i].app,
                                        type: filterList[i].type,
                                        price: (response.data[mapList[i]].data.price_overview.final / 100).toFixed(2)
                                    })
                                } else {
                                    gameList.push({
                                        name: filterList[i].name,
                                        app: filterList[i].app,
                                        type: filterList[i].type,
                                        price: "-"
                                    })
                                }
                            }  
                        }
                    })
                    .catch(function(error) {})
                $scope.game = gameList;
            };
        });
    </script>
</body>

</html>